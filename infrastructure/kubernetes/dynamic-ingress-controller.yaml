# Dynamic Ingress Controller
# Service that watches for domain verification and creates ingress rules

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dynamic-ingress-controller
  namespace: email-system
spec:
  replicas: 2
  selector:
    matchLabels:
      app: dynamic-ingress-controller
  template:
    metadata:
      labels:
        app: dynamic-ingress-controller
    spec:
      serviceAccountName: domain-cert-manager
      containers:
        - name: controller
          image: dynamic-ingress-controller:latest
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: database-credentials
                  key: url
            - name: KUBERNETES_NAMESPACE
              value: email-system
            - name: PRIMARY_DOMAIN
              value: enterprise-email.com
            - name: CERT_ISSUER
              value: letsencrypt-prod
            - name: LOG_LEVEL
              value: info
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 9090
              name: metrics
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"

---
apiVersion: v1
kind: Service
metadata:
  name: dynamic-ingress-controller
  namespace: email-system
spec:
  selector:
    app: dynamic-ingress-controller
  ports:
    - name: http
      port: 8080
      targetPort: 8080
    - name: metrics
      port: 9090
      targetPort: 9090

---
# ConfigMap for Ingress Templates
apiVersion: v1
kind: ConfigMap
metadata:
  name: ingress-templates
  namespace: email-system
data:
  customer-domain-ingress.yaml: |
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: customer-{{DOMAIN_ID}}
      namespace: email-system
      annotations:
        kubernetes.io/ingress.class: nginx
        cert-manager.io/cluster-issuer: letsencrypt-prod
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/proxy-body-size: "50m"
        nginx.ingress.kubernetes.io/rate-limit: "{{RATE_LIMIT}}"
        nginx.ingress.kubernetes.io/configuration-snippet: |
          add_header X-Domain-ID "{{DOMAIN_ID}}" always;
      labels:
        app: mail-system
        domain: "{{DOMAIN_NAME}}"
        organization: "{{ORG_ID}}"
    spec:
      tls:
        - hosts:
            - "{{DOMAIN_NAME}}"
            - "webmail.{{DOMAIN_NAME}}"
            - "mail.{{DOMAIN_NAME}}"
          secretName: "{{DOMAIN_ID}}-tls"
      rules:
        - host: "webmail.{{DOMAIN_NAME}}"
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: web-client
                    port:
                      number: 80
        - host: "mail.{{DOMAIN_NAME}}"
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: web-client
                    port:
                      number: 80
