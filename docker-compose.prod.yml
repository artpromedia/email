# Production Docker Compose for OONRUMAIL
# Uses pre-built images from GitHub Container Registry (GHCR)
#
# Usage:
#   docker compose -f docker-compose.prod.yml pull
#   docker compose -f docker-compose.prod.yml up -d
#
# Required: .env file with all secrets (see .env.example)
# Images are pushed by CI/CD pipeline on every merge to main.

x-ghcr-image: &ghcr-image
  # Override IMAGE_TAG via env to deploy a specific commit, e.g. IMAGE_TAG=abc1234
  # Defaults to "latest" which tracks the most recent main branch build
  image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/${SERVICE_NAME}:${IMAGE_TAG:-latest}

services:
  # =========================================
  # INFRASTRUCTURE (not built by us)
  # =========================================
  postgres:
    image: postgres:16-alpine
    container_name: oonrumail-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-oonrumail}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-scripts/postgres:/docker-entrypoint-initdb.d:ro
      - ./docker/backups/postgres:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB:-oonrumail}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - email-network

  redis:
    image: redis:7-alpine
    container_name: oonrumail-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 512mb --maxmemory-policy allkeys-lru --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - email-network

  minio:
    image: minio/minio:latest
    container_name: oonrumail-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - email-network

  pgbouncer:
    image: bitnami/pgbouncer:latest
    container_name: oonrumail-pgbouncer
    restart: unless-stopped
    environment:
      DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-oonrumail}"
      PGBOUNCER_POOL_MODE: transaction
      PGBOUNCER_MAX_CLIENT_CONN: "200"
      PGBOUNCER_DEFAULT_POOL_SIZE: "20"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - email-network

  # =========================================
  # BACKEND SERVICES (from GHCR)
  # =========================================
  auth:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/auth:${IMAGE_TAG:-latest}
    container_name: oonrumail-auth
    restart: unless-stopped
    environment:
      PORT: "8080"
      SERVER_PORT: "8080"
      ENVIRONMENT: production
      SERVER_ENVIRONMENT: production
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-oonrumail}
      DATABASE_SSL_MODE: disable
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET_KEY: ${JWT_ACCESS_SECRET:?JWT_ACCESS_SECRET is required}
      JWT_ACCESS_EXPIRY: ${JWT_ACCESS_EXPIRY:-15m}
      JWT_REFRESH_EXPIRY: ${JWT_REFRESH_EXPIRY:-168h}
      BCRYPT_COST: ${BCRYPT_COST:-12}
      RATE_LIMIT_REQUESTS: ${AUTH_RATE_LIMIT:-100}
      RATE_LIMIT_WINDOW: ${AUTH_RATE_WINDOW:-1m}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      pgbouncer:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - email-network

  storage:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/storage:${IMAGE_TAG:-latest}
    container_name: oonrumail-storage
    restart: unless-stopped
    environment:
      PORT: "8085"
      ENVIRONMENT: production
      DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@pgbouncer:5432/${POSTGRES_DB:-oonrumail}?sslmode=disable"
      REDIS_URL: "redis:6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: "0"
      S3_ENDPOINT: "http://minio:9000"
      S3_ACCESS_KEY: ${MINIO_ROOT_USER}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      S3_BUCKET: ${S3_BUCKET:-attachments}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_USE_PATH_STYLE: "true"
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-26214400}
      QUOTA_ENABLED: ${QUOTA_ENABLED:-true}
      DEFAULT_QUOTA_MB: ${DEFAULT_QUOTA_MB:-5120}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      pgbouncer:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - email-network

  domain-manager:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/domain-manager:${IMAGE_TAG:-latest}
    container_name: oonrumail-domain-manager
    restart: unless-stopped
    environment:
      PORT: "8083"
      ENVIRONMENT: production
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_NAME: ${POSTGRES_DB:-oonrumail}
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_SSL_MODE: disable
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      DKIM_ENCRYPTION_KEY: ${DKIM_ENCRYPTION_KEY:?DKIM_ENCRYPTION_KEY is required}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      pgbouncer:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - email-network

  smtp-server:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/smtp-server:${IMAGE_TAG:-latest}
    container_name: oonrumail-smtp
    restart: unless-stopped
    environment:
      ENVIRONMENT: production
      SMTP_HOSTNAME: ${SMTP_HOSTNAME:-mail.oonrumail.com}
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_NAME: ${POSTGRES_DB:-oonrumail}
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_SSL_MODE: disable
      REDIS_ADDR: "redis:6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      DKIM_ENCRYPTION_KEY: ${DKIM_ENCRYPTION_KEY}
      TLS_CERT_FILE: /app/certs/server.crt
      TLS_KEY_FILE: /app/certs/server.key
      QUEUE_WORKERS: ${SMTP_QUEUE_WORKERS:-4}
      MAX_MESSAGE_SIZE: ${MAX_MESSAGE_SIZE:-26214400}
      MAX_RECIPIENTS: ${MAX_RECIPIENTS:-100}
    ports:
      - "25:25"
      - "587:587"
    volumes:
      - ./docker/certs/smtp:/app/certs:ro
      - smtp_queue_data:/app/data/queue
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      pgbouncer:
        condition: service_started
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "25"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - email-network

  imap-server:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/imap-server:${IMAGE_TAG:-latest}
    container_name: oonrumail-imap
    restart: unless-stopped
    environment:
      ENVIRONMENT: production
      IMAP_HOST: "0.0.0.0"
      IMAP_PORT: "143"
      IMAP_TLS_PORT: "993"
      DB_HOST: pgbouncer
      DB_PORT: "5432"
      DB_NAME: ${POSTGRES_DB:-oonrumail}
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      S3_ENDPOINT: "http://minio:9000"
      S3_ACCESS_KEY: ${MINIO_ROOT_USER}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      S3_BUCKET: ${S3_BUCKET:-attachments}
      TLS_CERT_FILE: /etc/ssl/certs/imap.crt
      TLS_KEY_FILE: /etc/ssl/private/imap.key
    ports:
      - "143:143"
      - "993:993"
    volumes:
      - ./docker/certs/imap:/etc/ssl/certs:ro
      - ./docker/certs/imap:/etc/ssl/private:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      pgbouncer:
        condition: service_started
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "143"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - email-network

  calendar:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/calendar:${IMAGE_TAG:-latest}
    container_name: oonrumail-calendar
    restart: unless-stopped
    environment:
      DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-oonrumail}?sslmode=disable"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379/2"
      SMTP_HOST: smtp-server
      SMTP_PORT: "25"
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      DOMAIN: ${CALENDAR_DOMAIN:-calendar.oonrumail.com}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      pgbouncer:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - email-network

  contacts:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/contacts:${IMAGE_TAG:-latest}
    container_name: oonrumail-contacts
    restart: unless-stopped
    environment:
      DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-oonrumail}?sslmode=disable"
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      DOMAIN: ${CONTACTS_DOMAIN:-contacts.oonrumail.com}
      AUTH_SERVICE_URL: "http://auth:8080"
    volumes:
      - contacts_photos:/data/photos
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8083/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - email-network

  chat:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/chat:${IMAGE_TAG:-latest}
    container_name: oonrumail-chat
    restart: unless-stopped
    environment:
      CHAT_PORT: "8086"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-oonrumail}?sslmode=disable"
      REDIS_ADDR: "redis:6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_ACCESS_SECRET:?JWT_ACCESS_SECRET is required}
      AUTH_SERVICE_URL: "http://auth:8080"
      S3_ENDPOINT: "http://minio:9000"
      S3_ACCESS_KEY: ${MINIO_ROOT_USER}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      CHAT_BUCKET: chat-files
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      pgbouncer:
        condition: service_started
      auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8086/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - email-network

  transactional-api:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/transactional-api:${IMAGE_TAG:-latest}
    container_name: oonrumail-transactional-api
    restart: unless-stopped
    environment:
      PORT: "8085"
      ENVIRONMENT: production
      DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-oonrumail}?sslmode=disable"
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      SMTP_HOST: smtp-server
      SMTP_PORT: "25"
      SMTP_QUEUE_URL: "redis://:${REDIS_PASSWORD}@redis:6379/1"
      TRACKING_ENABLED: ${TRACKING_ENABLED:-true}
      TRACKING_URL: ${TRACKING_URL:-https://api.oonrumail.com}
      WEBHOOK_SIGNATURE_KEY: ${WEBHOOK_SIGNATURE_KEY:-}
      S3_ENDPOINT: "http://minio:9000"
      S3_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      S3_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      S3_BUCKET: templates
      BASE_URL: ${TRANSACTIONAL_API_URL:-https://api.oonrumail.com}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      smtp-server:
        condition: service_healthy
      pgbouncer:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - email-network

  sms-gateway:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/sms-gateway:${IMAGE_TAG:-latest}
    container_name: oonrumail-sms-gateway
    restart: unless-stopped
    environment:
      SMS_GATEWAY_PORT: "8087"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-oonrumail}?sslmode=disable"
      REDIS_ADDR: "redis:6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_ACCESS_SECRET:?JWT_ACCESS_SECRET is required}
      TWILIO_ENABLED: ${TWILIO_ENABLED:-false}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER:-}
      VONAGE_ENABLED: ${VONAGE_ENABLED:-false}
      VONAGE_API_KEY: ${VONAGE_API_KEY:-}
      VONAGE_API_SECRET: ${VONAGE_API_SECRET:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      pgbouncer:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8087/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - email-network

  ai-assistant:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/ai-assistant:${IMAGE_TAG:-latest}
    container_name: oonrumail-ai-assistant
    restart: unless-stopped
    environment:
      PORT: "8090"
      ENVIRONMENT: production
      DB_HOST: pgbouncer
      DB_PORT: "5432"
      DB_NAME: ${POSTGRES_DB:-oonrumail}
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      AI_PROVIDER: ${AI_PROVIDER:-openai}
      AI_MODEL: ${AI_MODEL:-gpt-4-turbo-preview}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      pgbouncer:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - email-network

  # =========================================
  # FRONTEND APPS (from GHCR)
  # =========================================
  web:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/web:${IMAGE_TAG:-latest}
    container_name: oonrumail-web
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://api.oonrumail.com}
      NEXT_PUBLIC_AUTH_URL: ${NEXT_PUBLIC_AUTH_URL:-https://api.oonrumail.com/auth}
      NEXT_PUBLIC_STORAGE_URL: ${NEXT_PUBLIC_STORAGE_URL:-https://api.oonrumail.com/storage}
      MARKETING_DOMAIN: ${MARKETING_DOMAIN:-www.oonrumail.com}
      MAIL_DOMAIN: ${MAIL_DOMAIN:-mail.oonrumail.com}
    expose:
      - "3000"
    depends_on:
      - auth
      - storage
    networks:
      - email-network

  admin:
    image: ghcr.io/${GITHUB_REPO:-artpromedia/email}/admin:${IMAGE_TAG:-latest}
    container_name: oonrumail-admin
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://api.oonrumail.com}
      NEXT_PUBLIC_AUTH_URL: ${NEXT_PUBLIC_AUTH_URL:-https://api.oonrumail.com/auth}
    expose:
      - "3001"
    depends_on:
      - auth
    networks:
      - email-network

  # =========================================
  # REVERSE PROXY
  # =========================================
  caddy:
    image: caddy:2-alpine
    container_name: oonrumail-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./docker/config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - web
      - admin
      - auth
      - storage
      - transactional-api
      - domain-manager
    networks:
      - email-network

  # =========================================
  # MONITORING
  # =========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: oonrumail-prometheus
    restart: unless-stopped
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=30d"
    volumes:
      - ./infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./infrastructure/monitoring/alert-rules.yml:/etc/prometheus/alert-rules.yml:ro
      - prometheus_data:/prometheus
    networks:
      - email-network

  grafana:
    image: grafana/grafana:latest
    container_name: oonrumail-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - email-network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  smtp_queue_data:
    driver: local
  contacts_photos:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  email-network:
    driver: bridge
