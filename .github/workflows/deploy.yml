name: Deploy

# Manual deployment trigger with options for rollback and targeted deploys
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging
      image_tag:
        description: "Image tag to deploy (commit SHA or 'latest')"
        required: false
        default: "latest"
        type: string
      services:
        description: "Services to deploy (comma-separated, or 'all')"
        required: false
        default: "all"
        type: string
      skip_backup:
        description: "Skip pre-deploy database backup"
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

env:
  DEPLOY_DIR: /opt/oonrumail/app

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.parse.outputs.services }}
    steps:
      - name: Parse services
        id: parse
        run: |
          if [ "${{ inputs.services }}" = "all" ]; then
            echo "services=auth,storage,domain-manager,contacts,calendar,chat,transactional-api,sms-gateway,ai-assistant,smtp-server,imap-server,web,admin" >> $GITHUB_OUTPUT
          else
            echo "services=${{ inputs.services }}" >> $GITHUB_OUTPUT
          fi

      - name: Verify images exist in GHCR
        run: |
          TAG="${{ inputs.image_tag }}"
          IFS=',' read -ra SERVICES <<< "${{ steps.parse.outputs.services }}"

          echo "Checking images with tag: ${TAG}"
          echo "(Will verify during pull — skipping pre-check on ubuntu-latest)"
          for svc in "${SERVICES[@]}"; do
            svc=$(echo "$svc" | xargs)
            echo "  ghcr.io/${{ github.repository }}/${svc}:${TAG} — will pull on deploy runner"
          done

  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: [self-hosted, "${{ inputs.environment }}"]
    needs: validate
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.environment == 'production' && 'https://mail.oonrumail.com' || 'https://staging.oonrumail.com' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync to deploy directory
        run: |
          mkdir -p ${{ env.DEPLOY_DIR }}
          rsync -a --delete \
            --exclude='.env' \
            --exclude='.git' \
            --exclude='node_modules' \
            "${{ github.workspace }}/" "${{ env.DEPLOY_DIR }}/"

      - name: Pre-deploy database backup
        if: ${{ inputs.skip_backup != true }}
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          BACKUP_DIR="/opt/oonrumail/backups/deploys"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p "${BACKUP_DIR}"

          echo "Creating pre-deploy backup..."
          docker compose exec -T postgres \
            pg_dump -U "${POSTGRES_USER:-oonrumail}" "${POSTGRES_DB:-oonrumail}" \
            | gzip > "${BACKUP_DIR}/manual-deploy-${TIMESTAMP}.sql.gz" || true

          # Keep only last 10 backups
          ls -t "${BACKUP_DIR}"/*.sql.gz 2>/dev/null | tail -n +11 | xargs rm -f 2>/dev/null || true

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull Docker images
        working-directory: ${{ env.DEPLOY_DIR }}
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          SERVICES="${{ needs.validate.outputs.services }}"
          IFS=',' read -ra SVC_ARRAY <<< "${SERVICES}"

          echo "Pulling images (tag: ${IMAGE_TAG})..."
          FAILED=""
          for svc in "${SVC_ARRAY[@]}"; do
            svc=$(echo "$svc" | xargs)
            IMAGE="ghcr.io/${{ github.repository }}/${svc}:${IMAGE_TAG}"
            echo "  Pulling ${IMAGE}..."
            if docker pull "${IMAGE}" 2>/dev/null; then
              echo "    ✅ ${svc} pulled"
            else
              echo "    ⚠️  ${svc} not available in GHCR, will use existing local image"
              FAILED="${FAILED} ${svc}"
            fi
          done
          if [ -n "$FAILED" ]; then
            echo "::warning::Some images not found in GHCR:${FAILED}"
          fi

      - name: Deploy services
        working-directory: ${{ env.DEPLOY_DIR }}
        run: |
          echo "Deploying with docker compose (default project)..."
          docker compose up -d --remove-orphans 2>&1 || true

          # Reload Caddy config
          docker compose exec -T caddy caddy reload --config /etc/caddy/Caddyfile 2>/dev/null || true

      - name: Health checks
        working-directory: ${{ env.DEPLOY_DIR }}
        continue-on-error: true
        run: |
          sleep 20

          echo "Container status:"
          docker compose ps --format "table {{.Name}}\t{{.Status}}" 2>/dev/null || \
            docker compose ps

          RUNNING=$(docker compose ps --status running -q 2>/dev/null | wc -l)
          echo ""
          echo "Running containers: ${RUNNING}"

          if [ "$RUNNING" -ge 5 ]; then
            echo "✅ Deploy complete! (tag: ${{ inputs.image_tag }})"
          else
            echo "⚠️ Only ${RUNNING} containers running — check logs"
          fi

      - name: Cleanup old Docker images
        if: always()
        run: docker image prune -f --filter "until=168h" 2>/dev/null || true

  rollback:
    name: Rollback Info
    runs-on: [self-hosted, "${{ inputs.environment }}"]
    needs: deploy
    if: failure()
    steps:
      - name: Rollback instructions
        run: |
          echo "::error::Deployment failed! To rollback:"
          echo ""
          echo "Recent database backups:"
          ls -lt /opt/oonrumail/backups/deploys/*.sql.gz 2>/dev/null | head -5 || echo "  No backups found"
          echo ""
          echo "To rollback, re-run this workflow with a previous commit SHA as the image_tag."
          echo ""
          echo "Or run manually on this server:"
          echo "   cd /opt/oonrumail/app"
          echo "   docker compose up -d"
          echo ""
          echo "To restore database from backup:"
          echo "   gunzip -c /opt/oonrumail/backups/deploys/<backup>.sql.gz | \\"
          echo "   docker compose exec -T postgres psql -U oonrumail"
