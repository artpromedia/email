# Dovecot Configuration - CEERION Mail Server
# IMAP/LMTP/JMAP with PostgreSQL backend

# === Basic Configuration ===
protocols = imap lmtp jmap
listen = *
base_dir = /run/dovecot/
instance_name = dovecot

# === Logging ===
log_path = /var/log/dovecot/dovecot.log
info_log_path = /var/log/dovecot/dovecot-info.log
debug_log_path = /var/log/dovecot/dovecot-debug.log
syslog_facility = mail
auth_verbose = yes
auth_debug = no
mail_debug = no

# === SSL/TLS Configuration ===
ssl = required
ssl_cert = </etc/ssl/certs/mail.ceerion.com.crt
ssl_key = </etc/ssl/private/mail.ceerion.com.key
ssl_ca = </etc/ssl/certs/ca-certificates.crt

# SSL Security Settings
ssl_protocols = !SSLv2 !SSLv3 !TLSv1 !TLSv1.1
ssl_cipher_list = ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS
ssl_prefer_server_ciphers = yes
ssl_dh = </etc/dovecot/dh.pem

# === Mail Location ===
mail_location = maildir:/var/mail/%d/%n/Maildir
mail_uid = vmail
mail_gid = vmail
first_valid_uid = 5000
last_valid_uid = 5000

# === Namespace Configuration ===
namespace inbox {
  type = private
  separator = /
  prefix = INBOX/
  inbox = yes
  hidden = no
  list = yes
  subscriptions = yes
  
  mailbox Drafts {
    special_use = \Drafts
    auto = subscribe
  }
  mailbox Junk {
    special_use = \Junk
    auto = subscribe
  }
  mailbox Sent {
    special_use = \Sent
    auto = subscribe
  }
  mailbox "Sent Messages" {
    special_use = \Sent
  }
  mailbox Trash {
    special_use = \Trash
    auto = subscribe
  }
}

# === Authentication ===
auth_mechanisms = plain login
auth_cache_size = 1M
auth_cache_ttl = 1 hour
auth_cache_negative_ttl = 1 hour

# PostgreSQL Authentication
passdb {
  driver = sql
  args = /etc/dovecot/custom/dovecot-sql.conf.ext
}

userdb {
  driver = sql
  args = /etc/dovecot/custom/dovecot-sql.conf.ext
}

# === SASL for Postfix ===
service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
  }
  
  unix_listener auth-userdb {
    mode = 0600
    user = vmail
    group = vmail
  }
  
  user = dovecot
}

# === IMAP Configuration ===
service imap-login {
  inet_listener imap {
    port = 143
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }
  
  process_min_avail = 0
  process_limit = 1000
}

service imap {
  process_limit = 1024
}

# === LMTP Configuration ===
service lmtp {
  inet_listener lmtp {
    port = 24
  }
  
  process_min_avail = 5
  process_limit = 100
}

# === JMAP Configuration ===
service jmap {
  inet_listener jmap {
    port = 8080
  }
  
  process_limit = 100
}

# === Quota Configuration ===
plugin {
  quota = maildir:User quota
  quota_rule = *:storage=5G
  quota_rule2 = Trash:storage=+100M
  quota_warning = storage=95%% quota-warning 95 %u
  quota_warning2 = storage=80%% quota-warning 80 %u
  quota_exceeded_message = Quota exceeded, please delete some messages first.
}

service quota-warning {
  executable = script /usr/local/bin/quota-warning.sh
  user = vmail
  unix_listener quota-warning {
    user = vmail
    group = vmail
    mode = 0660
  }
}

# === Sieve Configuration ===
plugin {
  sieve = file:~/sieve;active=~/.dovecot.sieve
  sieve_default = /var/lib/dovecot/sieve/default.sieve
  sieve_dir = ~/sieve
  sieve_global_dir = /var/lib/dovecot/sieve/global/
}

service managesieve-login {
  inet_listener sieve {
    port = 4190
  }
}

service managesieve {
  process_limit = 1024
}

# === FTS (Full Text Search) ===
plugin {
  fts = lucene
  fts_lucene = whitespace_chars=@.
  fts_autoindex = yes
  fts_enforced = yes
}

# === Push Notifications for JMAP ===
plugin {
  push_notification_driver = lua:push_notification.lua
}

# === Security Settings ===
mail_max_userip_connections = 20
imap_idle_notify_interval = 2 mins
maildir_very_dirty_syncs = yes

# === Mailbox Settings ===
mbox_write_locks = fcntl
maildir_stat_dirs = yes
mailbox_idle_check_interval = 30 secs

# === Performance Tuning ===
mail_cache_min_mail_count = 10
mail_cache_fields = flags
maildir_copy_with_hardlinks = yes
mmap_disable = no
mail_fsync = optimized

# === Anti-Spam Integration ===
plugin {
  antispam_backend = pipe
  antispam_trash = Trash;Junk
  antispam_spam = Junk
  antispam_pipe_program_spam_arg = /usr/local/bin/rspamd-learn-spam.sh
  antispam_pipe_program_notspam_arg = /usr/local/bin/rspamd-learn-ham.sh
}
