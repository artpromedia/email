# Caddyfile for OONRUMAIL
# Automatic HTTPS with Let's Encrypt

{
    email admin@oonrumail.com
}

# Marketing / landing page - served at oonrumail.com (bare domain)
# The Next.js middleware restricts this domain to marketing & auth pages only
oonrumail.com {
    reverse_proxy web:3000
    encode gzip

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}

# www redirects to bare domain (landing page)
www.oonrumail.com {
    redir https://oonrumail.com{uri} permanent
}

# Mail application - served at mail.oonrumail.com (primary) and app.oonrumail.com (alias)
# The Next.js middleware redirects to mail.oonrumail.com from www when accessing app routes
app.oonrumail.com, mail.oonrumail.com {
    reverse_proxy web:3000
    encode gzip

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}

# Skillancer mail application - white-label login for Skillancer org
mail.skillancer.com {
    reverse_proxy web:3000
    encode gzip

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}

# Admin panel
admin.oonrumail.com {
    reverse_proxy admin:3001
    encode gzip

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
    }
}

# Shared API route snippet (imported via Caddyfile snippet)
(api_routes) {
    # Auth service
    handle /auth/* {
        uri strip_prefix /auth
        reverse_proxy auth:8080
    }

    # Storage service
    handle /storage/* {
        uri strip_prefix /storage
        reverse_proxy storage:8085
    }

    # Contacts service
    handle /contacts/* {
        uri strip_prefix /contacts
        reverse_proxy contacts:8083
    }

    # Calendar service
    handle /calendar/* {
        uri strip_prefix /calendar
        reverse_proxy calendar:8082
    }

    # Chat service
    handle /chat/* {
        uri strip_prefix /chat
        reverse_proxy chat:8086
    }

    # Transactional email API
    handle /v1/* {
        reverse_proxy transactional-api:8085
    }

    # Domain manager
    handle /domains/* {
        uri strip_prefix /domains
        reverse_proxy domain-manager:8083
    }

    # SMS Gateway
    handle /sms/* {
        uri strip_prefix /sms
        reverse_proxy sms-gateway:8087
    }

    # AI Assistant
    handle /ai/* {
        uri strip_prefix /ai
        reverse_proxy ai-assistant:8090
    }

    # Default - auth service for login/register
    handle {
        reverse_proxy auth:8080
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
        Access-Control-Allow-Headers "Authorization, Content-Type, X-API-Key, X-Request-ID"
        Access-Control-Allow-Credentials "true"
        Access-Control-Max-Age "300"
    }
}

# API endpoints - OonruMail
api.oonrumail.com {
    import api_routes

    # Dynamic CORS: reflect the Origin header for allowed origins
    @oonrumailOrigin header Origin https://mail.oonrumail.com
    header @oonrumailOrigin Access-Control-Allow-Origin "https://mail.oonrumail.com"

    @adminOrigin header Origin https://admin.oonrumail.com
    header @adminOrigin Access-Control-Allow-Origin "https://admin.oonrumail.com"

    @landingOrigin header Origin https://oonrumail.com
    header @landingOrigin Access-Control-Allow-Origin "https://oonrumail.com"

    @skillancerOrigin header Origin https://mail.skillancer.com
    header @skillancerOrigin Access-Control-Allow-Origin "https://mail.skillancer.com"
}

# API endpoints - Skillancer (white-label)
api.skillancer.com {
    import api_routes

    # CORS for Skillancer mail app
    @skillancerMailOrigin header Origin https://mail.skillancer.com
    header @skillancerMailOrigin Access-Control-Allow-Origin "https://mail.skillancer.com"

    # Also allow OonruMail origins (platform admin)
    @oonrumailAdminOrigin header Origin https://admin.oonrumail.com
    header @oonrumailAdminOrigin Access-Control-Allow-Origin "https://admin.oonrumail.com"
}

# NOTE: If using Cloudflare proxy for oonrumail.com and www.oonrumail.com,
# set Cloudflare SSL mode to "Full (strict)" so Caddy can still issue
# its own certificates and Cloudflare forwards traffic to Caddy correctly.
